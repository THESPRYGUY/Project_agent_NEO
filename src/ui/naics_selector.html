<section class="naics-picker" data-naics-picker>
  <style>
    .naics-picker { margin: 0.75rem 0 0.5rem; }
    .naics-picker .row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem; }
    .naics-picker .row-full { display: block; margin-bottom: 0.5rem; }
    .naics-picker select, .naics-picker input[type=text] { width: 100%; padding: 0.4rem; border: 1px solid #ccd; border-radius: 6px; }
    .naics-picker button { background: #1f3c88; color: #fff; border: none; border-radius: 6px; padding: 0.5rem 0.75rem; cursor: pointer; }
    .naics-tip { color: #586; font-size: 0.9rem; margin: 0.25rem 0 0.5rem; }
  </style>

  <div class="row-full">
    <input type="text" data-naics-search placeholder="Search NAICS (code or title e.g., 54, software)">
    <div class="naics-tip">Search to filter, or select a top-level sector below.</div>
  </div>
  <div class="row">
    <select data-naics-level="2"><option value="">Level 2 (2‑digit)</option></select>
    <select data-naics-level="3" disabled><option value="">Level 3 (3‑digit)</option></select>
  </div>
  <div class="row">
    <select data-naics-level="4" disabled><option value="">Level 4 (4‑digit)</option></select>
    <select data-naics-level="5" disabled><option value="">Level 5 (5‑digit)</option></select>
  </div>
  <div class="row">
    <select data-naics-level="6" disabled><option value="">Level 6 (6‑digit)</option></select>
    <button type="button" data-naics-confirm disabled>Confirm NAICS</button>
  </div>

  <script>
    (function () {
      const root = document.currentScript && document.currentScript.closest('[data-naics-picker]') || document.querySelector('[data-naics-picker]');
      if (!root) { return; }
      const get = (sel) => root.querySelector(sel);
      const api = (p) => fetch(p, { credentials: 'same-origin' }).then(r => r.text()).then(t => { try { return JSON.parse(t); } catch(_) { return null; } });

      const searchBox = get('[data-naics-search]');
      const selects = [2,3,4,5,6].map(l => get(`[data-naics-level="${l}"]`));
      const btn = get('[data-naics-confirm]');

      const hidden = (name) => document.querySelector(`[name="${name}"]`);
      const hCode = hidden('naics_code');
      const hTitle = hidden('naics_title');
      const hLevel = hidden('naics_level');
      const hLineage = hidden('naics_lineage_json');

      function opt(value, label) { const o = document.createElement('option'); o.value = value; o.textContent = label; return o; }
      function clearFrom(level) { for (let i = 0; i < selects.length; i++) { const s = selects[i]; const lv = 2 + i; if (lv >= level) { s.innerHTML = `<option value="">Level ${lv} (${lv}-digit)</option>`; s.disabled = true; } } }
      function enableConfirmIfReady() { const code = getSelectedCode(); btn.disabled = !code; }
      function getSelectedCode() { for (let i = selects.length - 1; i >= 0; i--) { const s = selects[i]; if (s && !s.disabled && s.value) { return s.value; } } return ''; }

      async function loadRoots() {
        const res = await api('/api/naics/roots');
        const s2 = selects[0];
        if (res && Array.isArray(res.items)) {
          s2.innerHTML = '<option value="">Level 2 (2‑digit)</option>';
          res.items.forEach(item => s2.append(opt(item.code, `${item.code} — ${item.title}`)));
          s2.disabled = false;
        }
        enableConfirmIfReady();
      }

      async function loadChildren(parent, level) {
        const idx = level - 2; // index in selects
        const s = selects[idx];
        if (!s) return;
        const res = await api(`/api/naics/children/${encodeURIComponent(parent)}?level=${level}`);
        s.innerHTML = `<option value="">Level ${level} (${level}-digit)</option>`;
        if (res && Array.isArray(res.items)) {
          res.items.forEach(item => s.append(opt(item.code, `${item.code} — ${item.title}`)));
          s.disabled = false;
        } else {
          s.disabled = true;
        }
        // clear deeper levels
        clearFrom(level + 1);
        enableConfirmIfReady();
      }

      async function handleSelectChange(e) {
        const s = e.target; const lv = Number(s.getAttribute('data-naics-level')) || 0;
        if (!lv) return;
        // clear deeper levels then fetch next
        clearFrom(lv + 1);
        const code = s.value;
        if (code && lv < 6) { await loadChildren(code, lv + 1); }
        enableConfirmIfReady();
      }

      let timer = null;
      async function handleSearchInput() {
        const q = String(searchBox.value || '').trim();
        if (timer) { clearTimeout(timer); }
        timer = setTimeout(async () => {
          if (!q) return;
          const res = await api(`/api/naics/search?q=${encodeURIComponent(q)}`);
          if (res && Array.isArray(res.items) && res.items.length) {
            // pick the first result as a convenience: load its lineage to populate selects
            const pick = res.items[0];
            // traverse: fill level2..N selects where possible
            clearFrom(2);
            const path = (pick.code || '').split('').reduce((acc, ch, i) => { const c = (acc[i-1]||'') + ch; acc.push(c); return acc; }, []);
            // path will be like ['5','54','541','5411',...]; start from 2-digit
            const steps = path.filter(c => c.length >= 2 && c.length <= 6);
            if (steps.length) {
              // load roots then children chains
              await loadRoots();
              // set progressively
              for (let i=0;i<steps.length;i++) {
                const code = steps[i];
                const level = code.length;
                // ensure current level select has the code option; if not, fetch children from parent
                const s = selects[level-2];
                if (s && !Array.from(s.options).some(o => o.value === code)) {
                  const parent = code.slice(0, code.length-1);
                  await loadChildren(parent, level);
                }
                if (s) { s.value = code; s.disabled = false; }
              }
              enableConfirmIfReady();
            }
          }
        }, 250);
      }

      async function handleConfirm() {
        const code = getSelectedCode();
        if (!code) return;
        const detail = await api(`/api/naics/code/${encodeURIComponent(code)}`);
        const entry = detail && detail.entry ? detail.entry : null;
        const lineage = entry && Array.isArray(entry.lineage) ? entry.lineage : [];
        if (hCode) hCode.value = code;
        if (hTitle) hTitle.value = entry && entry.title || '';
        if (hLevel) hLevel.value = String(entry && entry.level || code.length);
        if (hLineage) hLineage.value = JSON.stringify(lineage);
        // fire an input event so gating/preview listeners update
        document.dispatchEvent(new Event('input', { bubbles: true }));
        document.dispatchEvent(new Event('change', { bubbles: true }));
        btn.textContent = 'Confirmed';
        setTimeout(() => { btn.textContent = 'Confirm NAICS'; }, 800);
      }

      // Wire events
      selects.forEach(s => s && s.addEventListener('change', handleSelectChange));
      if (searchBox) searchBox.addEventListener('input', handleSearchInput);
      if (btn) btn.addEventListener('click', handleConfirm);

      // Init
      loadRoots();
    })();
  </script>
</section>

