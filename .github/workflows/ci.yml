name: CI
env:
  NEO_CONTRACT_MODE: full
on:
  pull_request: { branches: [main], types: [opened, reopened, synchronize] }
  push: { branches: [main, feature/**, hotfix/**] }
  workflow_dispatch: {}
permissions: { contents: read }
defaults: { run: { shell: bash } }
jobs:
  schema-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: python scripts/contract_validate.py generated_repos/agent-build-007-2-1-1
  intake-mapper-guard:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: mkdir -p tmp_art/guard
      - run: cp -R generated_repos/agent-build-007-2-1-1/. tmp_art/guard/
      - run: python tools/apply_intake.py --input data/intake_contract_v1_sample.json --root tmp_art/guard --dry-run --report tmp_art/guard/report.json
  placeholder-sweep:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: python scripts/placeholder_sweep.py --root generated_repos --project agent-build-007-2-1-1
  repo-audit:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: python scripts/repo_audit.py --root generated_repos/agent-build-007-2-1-1 --format json --fail-on high
  governance-crosscheck:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    env:
      PYTHONUTF8: "1"
      BUILD_ROOT: generated_repos/agent-build-007-2-1-1
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: python scripts/check_governance_crosspack.py --strict --root "$BUILD_ROOT"
  registry-consistency:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: python scripts/check_registry_consistency.py
  unit-python:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: pytest -q
  unit-js:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - run: npm ci
      - run: npm test --silent
  ui-schema-smoke:
    runs-on: ubuntu-latest
    needs: [unit-js, unit-python]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: "20" }
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: npm ci
      - run: python -m pip install -U pip && python -m pip install -e .[dev]
      - run: python scripts/ui_schema_smoke.py
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: python -m pip install -U pip && python -m pip install pre-commit
      - run: pre-commit run -a
