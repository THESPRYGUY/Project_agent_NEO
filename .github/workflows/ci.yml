name: CI (Unit + Integ/Smoke)

on:
  push:
    branches:
      - main
      - feature/**
      - feat/**
      - chore/**
      - hotfix/**
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: read
  actions: read
  checks: read

env:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8
  NEO_CONTRACT_MODE: full

defaults:
  run:
    shell: bash

jobs:
  schema-validate:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/src
      NEO_REPO_OUTDIR: ${{ runner.temp }}/_generated
      NEO_COPY_TO_ONEDRIVE: 'false'
      NEO_APPLY_OVERLAYS: 'false'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -e .[dev]
      - name: Schema validate generated repo
        id: schema
        run: |
          python scripts/contract_validate.py generated_repos/agent-build-007-2-1-1
      - name: Upload schema report
        if: always() && steps.schema.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: schema-validate-report
          path: generated_repos/agent-build-007-2-1-1/contract_report.json

  intake-mapper-guard:
    runs-on: ubuntu-latest
    needs: [schema-validate]
    env:
      PYTHONPATH: ${{ github.workspace }}/src
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -e .[dev]
      - name: Dry-run mapper against intake contract
        run: |
          python tools/apply_intake.py --input data/intake_contract_v1_sample.json --root generated_repos/agent-build-007-2-1-1 --dry-run --report generated_repos/agent-build-007-2-1-1/reports/intake_mapper_report.json
      - name: Assert mapper drift-free
        run: |
          python - <<'PY'
          import json
          import pathlib
          import sys

          report_path = pathlib.Path("generated_repos/agent-build-007-2-1-1/reports/intake_mapper_report.json")
          report = json.loads(report_path.read_text(encoding="utf-8"))
          changed = report.get("changed_files") or []
          if changed:
              print("intake-mapper-guard: drift detected in packs:", ", ".join(changed), file=sys.stderr)
              sys.exit(1)
          if report.get("diff_report"):
              print("intake-mapper-guard: diff report populated unexpectedly.", file=sys.stderr)
              sys.exit(1)
          print("intake-mapper-guard: OK - packs align with intake contract.")
          PY
      - name: Upload mapper report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: intake-mapper-report
          path: generated_repos/agent-build-007-2-1-1/reports/intake_mapper_report.json

  placeholder-sweep:
    runs-on: ubuntu-latest
    needs: [intake-mapper-guard]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -e .
      - name: Placeholder sweep
        run: |
          python scripts/placeholder_sweep.py --root generated_repos --project agent-build-007-2-1-1

  repo-audit:
    runs-on: ubuntu-latest
    needs: [placeholder-sweep]
    env:
      PYTHONPATH: ${{ github.workspace }}/src
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -e .[dev]
      - name: Run repo audit (fail on HIGH)
        id: audit
        run: |
          python scripts/repo_audit.py --root generated_repos/agent-build-007-2-1-1 --format md,json,csv --fail-on high
      - name: Upload repo audit artifacts
        if: always() && steps.audit.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: repo-audit-reports
          path: |
            generated_repos/agent-build-007-2-1-1/reports/blanks_audit.json
            generated_repos/agent-build-007-2-1-1/reports/blanks_audit.csv
            generated_repos/agent-build-007-2-1-1/docs/BLANKS_AUDIT.md
            generated_repos/agent-build-007-2-1-1/docs/BLANKS_REMEDIATION_PLAN.md

  unit-python:
    runs-on: ubuntu-latest
    needs: [repo-audit]
    env:
      PYTHONPATH: ${{ github.workspace }}/src
      NEO_REPO_OUTDIR: ${{ runner.temp }}/_generated
      NEO_COPY_TO_ONEDRIVE: 'false'
      FAIL_ON_PARITY: 'true'
      NEO_APPLY_OVERLAYS: 'false'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -e .[dev] coverage
      - name: Unit tests + coverage
        run: |
          coverage run -m pytest
          coverage report
      - name: Emit telemetry (unit)
        if: always()
        run: |
          python - <<'PY'
          import json
          agg={'event':'run_aggregates','build_duration_ms_p50':None,'build_duration_ms_p95':None,'zip_bytes_p50':None,'zip_bytes_p95':None,'redirect_generated_specs_hit_total':0,'build_locked_count_total':0}
          open('telemetry-unit.jsonl','w',encoding='utf-8').write(json.dumps(agg)+'\n')
          PY
      - name: Upload unit telemetry
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telemetry-unit.jsonl
          path: telemetry-unit.jsonl

  unit-js:
    runs-on: ubuntu-latest
    needs: [repo-audit]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Install deps
        run: npm ci
      - name: Unit tests
        run: npm test

  ui-schema-smoke:
    runs-on: ubuntu-latest
    needs: [unit-python, unit-js]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - name: Install Node deps
        run: npm ci
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -e .[dev]
      - name: Intake contract smoke
        run: python scripts/ui_schema_smoke.py
