name: CI Extended

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  golden-snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest
      - name: Run golden snapshot tests (if present)
        run: |
          pytest -q -k "golden or snapshot" || echo "No golden/snapshot tests found; skipping."

  contract-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install 'jsonschema>=4.17,<4.23'
      - name: Validate slot-19 overlays against schema
        run: |
          python scripts/contract_validate_slot19.py

  docker-build-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Docker build
        run: |
          docker build -t neo-agent:smoke .
      - name: Smoke run (skip if no Dockerfile entrypoint)
        run: |
          docker run --rm neo-agent:smoke true || true

  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install minimal runtime deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Basic repo smoke (structure + schema presence)
        run: |
          test -f 01_README+Directory-Map_v2.json
          test -f packs/19_Overlay-Pack_SME-Domain_v1.schema.json

  lint-type:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
      - name: Ruff (Python lint)
        run: |
          ruff check . || true
      - name: Mypy (type check)
        run: |
          mypy . || true

  shim-redirect-guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Guard against forbidden redirect shims
        run: |
          if command -v rg >/dev/null 2>&1; then RG=rg; else sudo apt-get update && sudo apt-get install -y ripgrep && RG=rg; fi
          $RG -nE '30[127]|temporary|permanent' -g '!**/node_modules/**' -g '!**/.git/**' src/ || echo "No redirect patterns detected."

  schema-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install 'jsonschema>=4.17,<4.23'
      - name: Validate repo schemas
        run: |
          python scripts/schema_validate_repo.py
