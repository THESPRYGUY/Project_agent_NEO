name: CI Extended

on:
  pull_request:
    branches: [main, staging]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:

  golden_snapshot_main:
    name: golden snapshot
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest
      - name: Discover golden/snapshot tests
        id: collect
        run: |
          set -e
          COUNT=$(pytest -q -k "golden or snapshot" --collect-only | grep -Eo '::' | wc -l | tr -d ' ')
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      - name: Run golden/snapshot tests
        if: steps.collect.outputs.count != '0'
        run: |
          pytest -q -k "golden or snapshot" --maxfail=1
      - name: No golden/snapshot tests found (skip)
        if: steps.collect.outputs.count == '0'
        run: echo "No golden/snapshot tests found; skipping."

  golden_snapshot_alias:
    name: golden-snapshot
    runs-on: ubuntu-latest
    needs: [golden_snapshot_main]
    if: ${{ always() }}
    steps:
      - run: |
          if [ "${{ needs.golden_snapshot_main.result }}" != "success" ]; then
            echo "Golden snapshot tests failed"
            exit 1
          fi
          echo "Golden snapshot alias context"
